# HabitTracker 数据库设计文档

## 表结构

### users 表
用户基本信息表

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| id | uuid | auth.uid() | 主键，与 auth 用户ID保持一致 |
| email | text | - | 用户邮箱 |
| display_name | text | - | 显示名称 |
| avatar_url | text | - | 头像URL |
| phone | text | - | 手机号 |
| created_at | timestamptz | now() | 创建时间 |
| updated_at | timestamptz | now() | 更新时间 |

### user_notifications 表
用户通知设置表

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| id | uuid | uuid_generate_v4() | 主键 |
| user_id | uuid | - | 外键关联users表 |
| email_notifications | boolean | true | 是否开启邮件通知 |
| push_notifications | boolean | true | 是否开启推送通知 |
| push_token | text | - | 推送设备token |
| created_at | timestamptz | now() | 创建时间 |
| updated_at | timestamptz | now() | 更新时间 |

### balances 表
用户余额表，记录用户的三种余额类型

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| id | uuid | uuid_generate_v4() | 主键 |
| user_id | uuid | - | 外键关联users表 |
| refundable_amount | numeric | 0 | 可退余额 |
| frozen_amount | numeric | 0 | 冻结金额 |
| cashback_amount | numeric | 0 | 返现金额 |
| created_at | timestamptz | now() | 创建时间 |
| updated_at | timestamptz | now() | 更新时间 |

### transactions 表
交易记录表，记录所有余额变动

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| id | uuid | uuid_generate_v4() | 主键 |
| user_id | uuid | - | 外键关联users表 |
| amount | numeric | - | 交易金额 |
| type | text | - | 交易类型(charge/refund/withdrawal) |
| reference_id | text | - | 外部交易参考号 |
| status | text | 'pending' | 交易状态(pending/succeeded/failed) |
| created_at | timestamptz | now() | 创建时间 |
| updated_at | timestamptz | now() | 更新时间 |

## 安全设置

### Row Level Security (RLS)
所有表都启用了行级安全性(RLS)，未被强制执行(非forced)。

#### users表策略
- SELECT: 用户只能读取自己的资料 `auth.uid() = id`
- UPDATE: 用户只能更新自己的资料 `auth.uid() = id`

#### user_notifications表策略
- ALL: 用户只能操作自己的通知设置 `auth.uid() = user_id`
- SELECT: 用户只能读取自己的通知设置 `auth.uid() = user_id`

#### Storage策略 (avatars bucket)
- SELECT: 头像图片可以公开访问
- INSERT: 已认证用户可以上传头像
- UPDATE: 用户只能更新自己的头像

## 关键扩展

- uuid-ossp：用于生成UUID
- pg_graphql：提供GraphQL支持
- pgjwt：提供JWT支持
- pgcrypto：提供加密功能

## SQL脚本

### 创建表
```sql
-- 创建users表
CREATE TABLE public.users (
    id uuid NOT NULL DEFAULT auth.uid(),
    email text,
    display_name text,
    avatar_url text,
    phone text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    CONSTRAINT users_pkey PRIMARY KEY (id),
    CONSTRAINT users_email_unique UNIQUE (email)
);

-- 创建user_notifications表
CREATE TABLE public.user_notifications (
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL,
    email_notifications boolean DEFAULT true,
    push_notifications boolean DEFAULT true,
    push_token text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    CONSTRAINT user_notifications_pkey PRIMARY KEY (id),
    CONSTRAINT user_notifications_user_fkey FOREIGN KEY (user_id) 
        REFERENCES public.users(id) ON DELETE CASCADE
);

-- 创建余额表
CREATE TABLE public.balances (
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL,
    refundable_amount numeric NOT NULL DEFAULT 0,
    frozen_amount numeric NOT NULL DEFAULT 0,
    cashback_amount numeric NOT NULL DEFAULT 0,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    CONSTRAINT balances_pkey PRIMARY KEY (id),
    CONSTRAINT balances_user_fkey FOREIGN KEY (user_id) 
        REFERENCES public.users(id) ON DELETE CASCADE
);

-- 创建交易记录表
CREATE TABLE public.transactions (
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL,
    amount numeric NOT NULL,
    type text NOT NULL,
    reference_id text,
    status text NOT NULL DEFAULT 'pending',
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    CONSTRAINT transactions_pkey PRIMARY KEY (id),
    CONSTRAINT transactions_user_fkey FOREIGN KEY (user_id) 
        REFERENCES public.users(id) ON DELETE CASCADE,
    CONSTRAINT transactions_type_check CHECK (type IN ('charge', 'refund', 'withdrawal')),
    CONSTRAINT transactions_status_check CHECK (status IN ('pending', 'succeeded', 'failed'))
);

-- 创建更新时间触发器
CREATE OR REPLACE FUNCTION handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 为users表添加触发器
CREATE TRIGGER set_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE PROCEDURE handle_updated_at();

-- 为user_notifications表添加触发器
CREATE TRIGGER set_updated_at
    BEFORE UPDATE ON user_notifications
    FOR EACH ROW
    EXECUTE PROCEDURE handle_updated_at();

-- 为balances表添加触发器
CREATE TRIGGER set_updated_at
    BEFORE UPDATE ON balances
    FOR EACH ROW
    EXECUTE PROCEDURE handle_updated_at();

-- 为transactions表添加触发器
CREATE TRIGGER set_updated_at
    BEFORE UPDATE ON transactions
    FOR EACH ROW
    EXECUTE PROCEDURE handle_updated_at();

-- 创建email唯一索引（忽略null值）
CREATE UNIQUE INDEX users_email_idx ON users(email) WHERE email IS NOT NULL;

-- 为balances表创建索引
CREATE INDEX balances_user_id_idx ON balances(user_id);

-- 为transactions表创建索引
CREATE INDEX transactions_user_id_idx ON transactions(user_id);
CREATE INDEX transactions_created_at_idx ON transactions(created_at);
```

### 权限策略
```sql
-- users表的RLS策略
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read their own profile"
ON public.users FOR SELECT
USING (auth.uid() = id);

CREATE POLICY "Users can update their own profile"
ON public.users FOR UPDATE
USING (auth.uid() = id);

-- user_notifications表的RLS策略
ALTER TABLE public.user_notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read their own notification settings"
ON public.user_notifications FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can update their own notification settings"
ON public.user_notifications FOR ALL
USING (auth.uid() = user_id);

-- Storage策略
CREATE POLICY "Avatar images are publicly accessible"
ON storage.objects FOR SELECT
USING (bucket_id = 'avatars');

CREATE POLICY "Users can upload avatar images"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'avatars' AND auth.role() = 'authenticated');

CREATE POLICY "Users can update their own avatar image"
ON storage.objects FOR UPDATE
USING (bucket_id = 'avatars' AND auth.uid() = owner)
WITH CHECK (bucket_id = 'avatars' AND auth.uid() = owner);
```

## TODO

- [x] 补充RLS策略详细说明
- [x] 添加自动更新updated_at的触发器
- [x] 添加users.email唯一索引
- [x] 设置user_notifications.user_id为非空
- [ ] 考虑添加数据备份策略说明