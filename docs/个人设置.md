## 个人设置管理 (User Profile & Settings)

本部分设计用户个人设置的数据存储与API接口，使用Supabase作为后端服务。

### 1. 数据库表设计

#### **public.users**
| 字段                   | 类型         | 说明                          |
|------------------------|--------------|-------------------------------|
| id                     | UUID         | 用户唯一标识 (Supabase Auth ID, PK) |
| email                  | text         | 邮箱 (可从 auth.users 同步)   |
| display_name           | text         | 用户显示名称                  |
| avatar_url             | text         | 用户头像URL                   |
| phone                  | text         | 手机号码                      |
| created_at             | timestamptz  | 创建时间                      |
| updated_at             | timestamptz  | 更新时间                      |


#### **public.user_notifications**
| 字段                   | 类型         | 说明                          |
|------------------------|--------------|-------------------------------|
| id                     | UUID         | 通知设置唯一标识 (PK)        |
| user_id                | UUID         | 用户ID (FK -> users.id)       |
| email_notifications    | boolean      | 是否接收邮件通知              |
| push_notifications     | boolean      | 是否接收推送通知              |
| push_token             | string       | PUSH PLUS TOKEN              |
| created_at             | timestamptz  | 创建时间                      |
| updated_at             | timestamptz  | 更新时间                      |

### 2. 领域模型定义 (TypeScript Interfaces)

```typescript
// 用户个人资料模型
interface UserProfile {
  id: string;
  email: string;
  displayName: string | null;
  avatarUrl: string | null;
  phone: string | null;
  createdAt: Date;
  updatedAt: Date;
}

// 用户通知设置模型
interface UserNotifications {
  id: string;
  userId: string;
  emailNotifications: boolean;
  pushNotifications: boolean;
  pushToken: string;
  createdAt: Date;
  updatedAt: Date;
}
```

### 3.接口设计

所有接口均使用Supabase提供的API自动生成，结合RLS (行级安全)策略确保用户只能访问自己的数据。

#### 用户个人资料 API

##### 获取用户个人资料
- **参数**: 
  - `id=eq.{current_user_id}`
- **权限**: 已认证用户可查看自己的资料，管理员可查看所有资料
- **Supabase 客户端示例**:
  ```typescript
  const { data, error } = await supabase
    .from('users')
    .select()
    .eq('id', currentUser.id)
    .single();
  ```

##### 更新用户个人资料
- **参数**: 
  - `id=eq.{current_user_id}`
- **请求体**: 用户资料更新字段
- **权限**: 已认证用户可更新自己的资料
- **Supabase 客户端示例**:
  ```typescript
  const { data, error } = await supabase
    .from('users')
    .update({ 
      display_name: updatedName,
      phone: updatedPhone,
      avatar_url: updatedAvatarUrl
    })
    .eq('id', currentUser.id);
  ```
#### 用户通知设置 API

##### 获取用户通知设置
- **参数**: 
  - `user_id=eq.{current_user_id}`
- **权限**: 已认证用户可查看自己的通知设置
- **Supabase 客户端示例**:
  ```typescript
  const { data, error } = await supabase
    .from('user_notifications')
    .select()
    .eq('user_id', currentUser.id)
    .single();
  ```

##### 更新用户通知设置
- **请求体**: 通知设置更新字段
- **权限**: 已认证用户可更新自己的通知设置
- **Supabase 客户端示例**:
  ```typescript
  const { data, error } = await supabase
    .from('user_notifications')
    .upsert({ 
      user_id: currentUser.id,
      email_notifications: enableEmailNotifications,
      push_notifications: enablePushNotifications,
      daily_reminder: enableDailyReminder,
      reminder_time: reminderTime
    })
    .eq('user_id', currentUser.id);
  ```

### 4. Supabase 行级安全策略 (RLS)

为确保数据安全，需要为每个表配置适当的行级安全策略:

#### users 表 RLS 策略

```sql
-- 用户可以读取自己的资料
CREATE POLICY "Users can read their own profile" ON public.users
  FOR SELECT USING (auth.uid() = id);

-- 用户可以更新自己的资料
CREATE POLICY "Users can update their own profile" ON public.users
  FOR UPDATE USING (auth.uid() = id);
```

#### user_notifications 表 RLS 策略

```sql
-- 用户可以读取自己的通知设置
CREATE POLICY "Users can read their own notification settings" ON public.user_notifications
  FOR SELECT USING (auth.uid() = user_id);

-- 用户可以更新自己的通知设置
CREATE POLICY "Users can update their own notification settings" ON public.user_notifications
  FOR ALL USING (auth.uid() = user_id);
```

### 5. 初始化与默认值

当用户首次注册时，可以通过数据库触发器为其创建默认用户信息和通知设置：


6. 前端页面
参考src\app\demo\components\settings中的页面设计
访问/settings这个path时，如果没有登录，应该跳转到登录界面
