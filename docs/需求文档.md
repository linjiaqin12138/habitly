### **需求细化思维导图**
```
每日习惯打卡软件
├─ 核心功能
│  ├─ 用户管理
│  │  ├─ 注册/登录 (使用supabase快速开发)
│  │  ├─ 个人资料（昵称、头像等）
│  │  └─ 权限控制（普通用户[公开注册]、管理员[通过 admin_users 表手动添加, 只读用户数据]）
│  ├─ 用户问卷设计 (用户级别)
│  │  ├─ 支持问题类型：单选、多选、填空、评分
│  │  ├─ 每个问题可设置分数（如：单选题选A得5分）
│  │  ├─ 用户可创建/编辑/删除自己的问卷模板
│  │  └─ 总分自定义（如：总分100分）
│  ├─ 打卡记录
│  │  ├─ 每日打卡状态（完成/未完成）
│  │  ├─ 记录用户答案及分数
│  │  ├─ 用户选择当前使用的问卷模板
│  │  └─ 遗漏打卡的补救机制（需手动输入文字）
│  ├─ 提醒系统
│  │  ├─ 每日超时未打卡时触发提醒（如：超过问卷设定的提醒时间未提交）
│  │  ├─ 支持邮件/应用内通知
│  │  ├─ 连续多日未打卡的强化提醒（如：3天未打卡时发送提醒）
│  │  └─ 超时未打卡通知包含链接，余额不足发送提醒
│  ├─ 防复制粘贴机制
│  │  ├─ 遗漏打卡后，再次打开需手动输入文字
│  │  ├─ 禁用粘贴事件（前端）
│  │  └─ 文字内容需符合规则（如：长度、关键词检查）
│  └─ 小金库管理
│     ├─ 用户设置小金库目标金额（最高1万元）
│     ├─ 每次打卡根据问卷规则增加可支取奖励
│     ├─ 支取奖励时用户自行从个人资金支付给自己
│     └─ 系统仅记录数字，不涉及真实支付流程
├─ 管理员功能 (只读)
│  ├─ 用户信息查看
│  │  ├─ 查看用户列表
│  │  └─ 查看用户详细信息（资料、打卡记录、余额等）
│  └─ **访问控制：管理员界面仅可通过内网或VPN访问**
└─ 非功能性需求
   ├─ 性能：支持千级用户并发
   ├─ 安全：敏感数据加密（如支付信息）
   └─ 可扩展性：问卷类型和提醒策略可扩展
```

### **用户交互流程 (Call Flow)**

1.  **注册/登录**:
    *   新用户访问 `/auth/register`，使用 `Input` 输入邮箱、密码完成注册。
    *   老用户访问 `/auth/login`，使用 `Input` 输入邮箱、密码进行登录。
    *   忘记密码的用户可通过 `/auth/forgot-password` 找回。

2.  **查看仪表盘 (Dashboard)**:
    *   登录后，用户默认进入 `/dashboard`。
    *   通过 `Card` 查看今日打卡状态、打卡完成率 (`Progress` 或文本)、本月进度、当前余额 (`¥xxx.xx` 格式) 和连续打卡天数。
    *   通过 `Table` 查看最近的打卡记录。

3.  **进行每日打卡**:
    *   用户导航到 `/checkin/<planid>` (或从 Dashboard 点击“去打卡”)。
    *   界面根据用户当前**激活**的问卷模板动态渲染问题列表。
    *   用户使用 `RadioGroup` (单选)、`Checkbox` (多选)、`Textarea`/`Input` (填空)、`Slider` (评分) 回答问题。
    *   完成后点击 `Button` 提交答案。系统记录答案和计算得分、返现。

4.  **处理超时未打卡**: 
    *   系统后台任务检测到用户超过其问卷设定的提醒时间 (`reminder_time`) 仍未打卡。
    *   系统发送通知（邮件/应用内）给用户，提醒其打卡。
    *   **通知内容包含一个直接跳转到打卡/补救页面的链接 (`/checkin/<planid>`)**。

5.  **处理错过打卡 (补救)**:
    *   如果用户某日未在提醒时间前打卡，访问打卡页面时会进入补救流程。
    *   界面显示错过的日期，并提供一个 `Textarea` 要求用户手动输入未打卡的原因。
    *   系统会禁用粘贴 (`onPaste`)，并检测输入速度 (`typingSpeedThreshold`) 防止作弊。
    *   用户需输入满足最小字数 (`minLength`) 的原因后，才能点击 `Button` 提交补救申请。

6.  **查看历史记录**:
    *   用户访问 `/history`.
    *   通过 `Calendar` 组件查看整个月的打卡情况（已打卡、未打卡、补打卡）。
    *   通过 `Table` 查看详细的打卡历史列表，包含日期、得分、状态等。

7.  **管理账户**:
    *   **个人设置 (`/settings/profile`)**: 用户可在此编辑昵称 (`Input`)、上传头像 (`Avatar` + 上传组件)、设置通知偏好 (`Switch`)。    *   **小金库管理 (`/settings/vault`)**:
        *   查看当前小金库金额和可支取奖励 (`Card`)。
        *   通过 `Input` 设置小金库目标金额（最高1万元）。
        *   查看金额变动记录 (`Table`)。
        *   通过 `Input` 和 `Button` 支取可得奖励。
        *   **当用户可支取奖励达到一定金额时，系统发送通知提醒用户支取。**
    *   **我的问卷 (`/settings/questionnaire`)**:
        *   用户在此管理自己的打卡问卷模板。
        *   提供创建新问卷 `Button`.
        *   (如果支持多个模板) 显示用户已创建的问卷列表，提供选择激活、编辑、删除 `Button`。
        *   点击“创建”或“编辑”进入问卷编辑器。
        *   在编辑器中使用 `Tabs` 切换“编辑”和“预览”。
        *   **编辑**: 设置问卷标题 (`Input`)、描述 (`Textarea`)、提醒时间 (`Input type="time"`)、打卡频率 (`Select`, `Switch`, `Calendar`)、返现规则 (`Input type="number"`) 以及添加/编辑问题 (`Card`, `Select`, `Input`, `Switch`)，包括为单选/多选的每个选项设置分数 (`Input type="number"`)。
        *   **预览**: 查看问卷在用户端的实际效果。

8.  **管理员操作 (Admin - 只读)**:
    *   **访问**: 管理员通过**内网或VPN**访问指定的管理后台地址。
    *   **用户管理 (`/admin/users`)**:
        *   管理员访问 `/admin/users` 查看用户列表 (`Table`)，可搜索 (`Input`)。
        *   对用户进行**查看详情**操作 (`Button` 或 `DropdownMenu`)，跳转到用户详情页。管理员**不能**编辑用户信息或删除用户。
    *   **用户详情 (`/admin/users/<userid>`)**:
        *   管理员查看特定用户的详细信息，如个人资料、账户余额、打卡历史、使用的问卷设置等（均为只读）。

---

### **技术选型细化思维导图**
```
技术选型
├─ 前端
│  ├─ 框架：Next.js（React Server Components + App Router）
│  ├─ UI库：Shadcn UI（基础组件如按钮、表单、对话框）
│  ├─ 问卷渲染：Survey.js（动态生成问卷）
│  ├─ 防复制粘贴：JavaScript事件监听（禁用`onPaste`、检查输入速度）
│  └─ 状态管理：Zustand（简单状态管理）
│
├─ 后端 & 数据库
│  ├─ 后端框架：Next.js API Routes（处理业务逻辑）
│  ├─ 数据库：Supabase（PostgreSQL + 实时订阅）
│  │  ├─ 表设计：
│  │  │  ├─ users（用户信息）
│  │  │  ├─ admin_users（管理员信息）
│  │  │  ├─ questionnaires（问卷模板）
│  │  │  │  └─ 字段：标题、问题列表（JSON）、总分、截止时间
│  │  │  ├─ responses（打卡记录）
│  │  │  │  └─ 字段：用户ID、问卷ID、答案数据（JSON）、得分、提交时间
│  │  │  └─ payments（充值和退款记录）
│  │  └─ 调度任务：Supabase Functions（定时检测未打卡用户）
│  │
│  └─ 支付系统：Stripe（处理充值和余额）
│
├─ 通知系统
│  ├─ 邮件：Nodemailer（通过Next.js API发送）
│  └─ 应用内通知：Supabase实时订阅（推送通知到前端）
│
├─ 防复制粘贴验证
│  ├─ 前端：禁用粘贴事件，记录输入时间戳
│  └─ 后端：检查输入内容是否符合逻辑规则（如：长度、非复制文本）
│
├─ 部署
│  ├─ 前端：Vercel
│  └─ 后端：Supabase Cloud 或自托管
│
└─ 其他工具
   ├─ 开发语言：TypeScript
   ├─ 路由：Next.js App Router
   └─ 部署：Vercel + Supabase
```

### **关键实现步骤**
1. **用户管理**:
   - 使用Supabase Auth处理普通用户的注册、登录、身份验证。
   - 用户表（`users`）存储用户ID、余额、**当前激活的问卷ID (`active_questionnaire_id`)** 等信息。
   - **UI**: 参考 `AuthDemo.tsx`, `SettingsDemo.tsx`.

2. **用户问卷设计**:
   - 问卷模板存储在 `questionnaires` 表，**包含 `user_id` 字段**，表示该模板属于哪个用户。
   - 用户通过特定界面（如 `/settings/questionnaire`）创建、编辑、删除自己的问卷。
   - **UI (编辑)**: 参考 `QuestionnaireDemo.tsx` 的 "编辑" 和 "预览" Tab，用户在此配置自己的问卷细节（问题、分数、频率、返现规则等）。
   - **UI (管理)**: 需要一个简单的列表（如果支持多模板）让用户选择激活哪个问卷，或直接提供编辑入口（如果只支持一个模板）。

3. **打卡记录**:
   - 每次打卡提交时，根据用户 `active_questionnaire_id` 对应的问卷模板，将答案和得分存储到`responses`表。
   - 后端计算总分。
   - **UI**: 参考 `CheckinDemo.tsx`.

4. **提醒系统**:
   - 每日定时任务（通过Supabase Functions或外部Cron）检查未打卡用户。   - 根据用户**激活问卷**中设置的提醒时间 (`reminder_time`) 触发通知。
   - **超时未打卡通知应包含指向打卡/补救页面的链接。**
   - **增加奖励提醒逻辑：当用户可支取奖励达到一定金额时，发送提醒通知鼓励用户支取。**

5. **防复制粘贴 (补救打卡)**:
   - 实现方式不变。
   - **UI**: 参考 `MakeupCheckinDemo.tsx`.

6. **小金库管理**:
   - 用户自行设置小金库目标金额（最高1万元），系统仅记录数字
   - 实际资金由用户自己管理，系统不涉及真实支付
   - 完成打卡后系统计算应得奖励，用户根据记录自行支取
   - 支持随时修改小金库金额，记录所有金额变动历史
   - **UI**: 参考 `VaultDemo.tsx`.

7. **管理员只读界面**:
   - 创建管理员角色（通过supabase中手动在 `auth.users` 创建用户并在 `admin_users` 表中添加记录实现），限制其数据库访问权限为只读用户相关数据。
   - **部署与访问**: 管理员界面应部署在特定环境中，确保**只能通过内网或VPN访问**。
   - **UI**: 参考 `UserManagementDemo.tsx`，但移除编辑/删除按钮，只保留查看详情功能。创建用户详情页展示信息。

---

### **数据库表结构示例**
#### **users**
| 字段                   | 类型         | 说明                          |
|------------------------|--------------|-------------------------------|
| id                     | UUID         | 用户唯一标识 (Supabase Auth ID, PK) |
| email                  | text         | 邮箱 (可从 auth.users 同步)   |
| vault_amount           | numeric      | 用户小金库金额                |
| available_rewards      | numeric      | 可支取奖励金额                |
| active_questionnaire_id | UUID         | 用户当前激活使用的问卷模板ID (FK -> questionnaires.id, nullable) |
| ... (其他个人资料字段) |              |                               |

#### **admin_users**
| 字段    | 类型 | 说明                                    |
|---------|------|-----------------------------------------|
| user_id | UUID | 管理员的用户 ID (PK, FK -> auth.users.id) |

#### **questionnaires**
| 字段          | 类型         | 说明                          |
|---------------|--------------|-------------------------------|
| id            | UUID         | 问卷模板ID                    |
| **user_id**   | **UUID**     | **关联的用户ID**              |
| title         | text         | 问卷标题                      |
| description   | text         | 问卷描述                      |
| questions     | jsonb        | 问题列表（包含类型、选项、分数）|
| frequency     | jsonb        | 打卡频率设置                  |
| cashback_rules| jsonb        | 返现规则列表                  |
| reminder_time | time         | 每日提醒时间（如21:00）       |
| created_at    | timestamp    | 创建时间                      |
| updated_at    | timestamp    | 最后更新时间                  |

#### **responses**
| 字段          | 类型         | 说明                          |
|---------------|--------------|-------------------------------|
| id            | UUID         | 打卡记录ID                    |
| user_id       | UUID         | 关联用户                      |
| questionnaire_id | UUID     | 关联问卷模板 (当时使用的版本) |
| answers       | jsonb        | 用户回答内容                  |
| score         | integer      | 当次得分                      |
| submitted_at  | timestamp    | 提交时间                      |
| is_makeup     | boolean      | 是否为补打卡                  |
| makeup_reason | text         | 补打卡原因 (如果 is_makeup=true) |

#### **vault_transactions**
| 字段          | 类型         | 说明                          |
|---------------|--------------|-------------------------------|
| id            | UUID         | 小金库交易记录ID              |
| user_id       | UUID         | 关联用户                      |
| amount        | numeric      | 变动金额 (正数表示增加, 负数表示支取) |
| type          | text         | 交易类型 ('adjust'调整金额, 'withdraw'支取奖励) |
| balance_after | numeric      | 变动后小金库余额              |
| description   | text         | 交易描述                      |
| created_at    | timestamp    | 交易时间                      |

---

### **技术选型理由**
- **Next.js**：SSR/SSG + API Routes，适合前后端分离架构。
- **Supabase**：开箱即用的Auth、实时数据库、简单易用的API，适合快速开发。
- **Survey.js**：支持多种题型，可动态生成问卷，减少自定义开发成本。
- **Shadcn UI**：提供高质量的UI组件，与Next.js和TypeScript兼容。
- **Stripe**：主流支付工具，支持灵活的充值和退款逻辑。
